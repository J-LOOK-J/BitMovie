<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data.repository.movie.ScreenTimeRepository">
    <insert id="insertScrTime" parameterType="screenTime">
        INSERT INTO screentime_tb VALUES
               (null,#{movie_pk},#{scrt_date},#{scrt_stime},#{scrt_etime})
    </insert>
    <select id="selectScrTimeByScreen" resultType="screenTime" parameterType="int">
        SELECT * FROM screentime_tb WHERE screen_pk=#{screen_pk}
    </select>
    <select id="selectScrTimeByTheater" resultType="screenTime" parameterType="int">
        SELECT * FROM screentime_tb WHERE theater_pk=#{theater_pk}
    </select>
    <update id="updateScrTimeByPk" parameterType="screenTime">
        UPDATE screentime_tb SET screen_pk=#{screen_pk}, movie_pk=#{movie_pk}, theater_pk=#{theater_pk}, scrt_date=#{scrt_date},
                                 scrt_stime=#{scrt_stime}, scrt_etime=#{scrt_etime} WHERE scrtime_pk=#{scrtime_pk}
    </update>
    <delete id="deleteScrTime" parameterType="int">
        DELETE FROM screentime_tb WHERE scrtime_pk=#{scrtime_pk}
    </delete>

    <resultMap id="screentime" type="screentime">
        <result column="scrt_date" property="scrt_date"/>
        <result column="scrt_stime" property="scrt_stime"/>
        <result column="scrt_etime" property="scrt_etime"/>
    </resultMap>

    <resultMap id="theater" type="theater">
        <result column="the_name" property="the_name"/>
    </resultMap>

    <select id="selectScrTimeByMovie" resultMap="screentime" parameterType="int">
        SELECT tt.the_name,st.scrt_date,st.scrt_stime,st.scrt_etime
        FROM screentime_tb st
                 JOIN theater_tb tt on st.theater_pk = tt.theater_pk
        WHERE st.movie_pk=1;
    </select>

    <!--  영화 출력시 필요한 예매울 분모 계산 (해당 날짜의 총 좌석수 구하기)  -->
    <select id="selectTotalSeat" parameterType="Map" resultType="int">
        SELECT sum(s.scr_tot_seat)
        FROM screentime_tb tim, screen_tb s
        WHERE tim.screen_pk = s.screen_pk AND tim.scrt_date > #{begin_date} AND #{now_date} >= tim.scrt_date
    </select>

    <!--  영화 페이지에서 상영 시간표 출력  -->
    <select id="selectTimeByMovie" parameterType="Map" resultType="JoinTime">
        SELECT tim.screen_pk,
               tim.movie_pk,
               tim.scrt_date,
               tim.scrt_stime,
               scr.scr_name,
               scr.seat_plot,
               scr.scr_tot_seat,
               th.the_name,
               (sum(book.book_youth_cnt) + sum(book.book_adult_cnt)) AS booked
        FROM screentime_tb tim, screen_tb scr, theater_tb th, booking_tb book
        WHERE tim.movie_pk= #{movie_pk}
          AND tim.scrt_date = #{date}
          AND scr.screen_pk = tim.screen_pk
          AND scr.theater_pk = th.theater_pk
          AND tim.scrtime_pk = book.scrtime_pk;
    </select>
</mapper>
