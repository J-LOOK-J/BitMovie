<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="data.repository.movie.JoinMovieRepository">
    <!--  영화 정보 + 예매횟수, 평균평점 정보 가져오기  -->
    <select id="selectMovieList" resultType="JoinMovie">
        select
            mv.movie_pk,
            mv.m_name,
            mv.m_type,
            mv.m_sdate,
            mv.m_edate,
            mv.m_runtime,
            mv.m_age_grd,
            mv.m_info,
            mv.m_photo,
            AVG(re.revw_star) AS revw_avgstar,
            sum_paycount
        FROM
            movie_tb mv LEFT OUTER JOIN review_tb re ON mv.movie_pk = re.movie_pk
            left outer join
                (SELECT
                    tim.movie_pk,
                    sum(book.book_adult_cnt + book.book_youth_cnt) AS sum_paycount
                FROM
                    payment_tb pay left outer join booking_tb book On pay.payment_pk = book.payment_pk
                    left outer join screentime_tb tim on book.scrtime_pk = tim.scrtime_pk
                where
                    "1970-01-22" > pay.pay_date
                    and pay.pay_date > "1970-01-19") sub on sub.movie_pk = mv.movie_pk
        group by (movie_pk);


    </select>
</mapper>